<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Published Forms</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="drafts.css">
    <link rel="stylesheet" href="admin-home.css">
    <link rel="stylesheet" href="admin-dashboard.css">
    <style>
        .page-container {
            margin-top: 80px; /* push content below fixed navbar */
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="logo">Anonymous Feedback System - Published Forms</div>
</nav>

<div class="drafts-container">
    <header class="drafts-header">
        <h2>Published Forms</h2>
        <p class="subtext">
            These forms are published and have shareable links for collecting anonymous feedback.
        </p>
        <button class="back-btn" onclick="goBackToDashboard()">‚Üê Back to Dashboard</button>
    </header>

    <section class="section-box" style="margin-bottom: 15px;">
        <div class="drafts-filters">
            <label for="domainFilter" class="subtext">Filter by domain:</label>
            <select id="domainFilter">
                <option value="">All Domains</option>
                <option value="school">School</option>
                <option value="college">College</option>
                <option value="corporate">Corporate</option>
                <option value="government">Government</option>
            </select>
        </div>
    </section>

    <section class="section-box drafts-list-section">
        <h3>Published Forms List</h3>
        <table class="dash-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Domain</th>
                    <th>Form Name</th>
                    <th>Status</th>
                    <th>Updated At</th>
                    <th>Public Link</th>
                </tr>
            </thead>
            <tbody id="publishedTableBody">
                <tr>
                    <td colspan="6">Loading published forms...</td>
                </tr>
            </tbody>
        </table>
    </section>
</div>

<script>
const API_BASE = "https://web-production-315e.up.railway.app";

const domainFilter = document.getElementById('domainFilter');
const tableBody = document.getElementById('publishedTableBody');

domainFilter.addEventListener('change', () => {
    loadPublishedForms(domainFilter.value);
});

function goBackToDashboard() {
    window.location.href = "admin-dashboard.html";
}

async function loadPublishedForms(domain = "") {
    const params = new URLSearchParams();
    if (domain) params.append("domain", domain);

    tableBody.innerHTML = `
        <tr>
            <td colspan="6">Loading published forms...</td>
        </tr>
    `;

    try {
        const res = await fetch(`${API_BASE}/admin/published-forms?` + params.toString());
        if (!res.ok) {
            console.error("API error", res.status);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6">Failed to load published forms.</td>
                </tr>
            `;
            return;
        }
        const data = await res.json();
        renderPublishedTable(Array.isArray(data) ? data : []);
    } catch (e) {
        console.error("Failed to load published forms", e);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6">Failed to load published forms.</td>
            </tr>
        `;
    }
}

function renderPublishedTable(items) {
    if (!items.length) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6">No published forms yet.</td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = "";

    items.forEach(t => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = t.id;

        const tdDomain = document.createElement("td");
        tdDomain.textContent = t.domain || "-";

        const tdName = document.createElement("td");
        tdName.textContent = t.name || "Untitled Form";

        const tdStatus = document.createElement("td");
        tdStatus.textContent = t.status || "published";

        const tdUpdated = document.createElement("td");
        tdUpdated.textContent = t.updated_at || "-";

        const tdLink = document.createElement("td");
        const publicUrl = `public-form.html?id=${t.id}`;
        tdLink.innerHTML = `<a href="${publicUrl}" target="_blank">${publicUrl}</a>`;

        tr.appendChild(tdId);
        tr.appendChild(tdDomain);
        tr.appendChild(tdName);
        tr.appendChild(tdStatus);
        tr.appendChild(tdUpdated);
        tr.appendChild(tdLink);

        tableBody.appendChild(tr);
    });
}

loadPublishedForms();
</script>

</body>
</html>
