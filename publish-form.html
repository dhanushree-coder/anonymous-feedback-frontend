<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Publish Form</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="publish-form.css">
</head>
<body>

<nav class="navbar">
    <div class="logo">Anonymous Feedback System - Admin</div>
</nav>

<section class="publish-container">
    <div class="publish-box">
        <h2>Publish Form</h2>
        <p class="subtext" id="formInfo">Loading form information...</p>

        <div id="errorBox" class="subtext" style="color:#ff6b6b; display:none;"></div>

        <div id="linkSection" style="display:none;">
            <p class="subtext">
                Click the button below to generate a public link for this form.
            </p>
            <button class="primary-btn" id="generateBtn" type="button">Generate Link</button>

            <!-- Link + copy area -->
            <div id="linkRow" style="display:none;">
                <div id="linkBox" class="publish-link-box"></div>

                <!-- Copy icon button under the link -->
                <button id="copyBtn" class="copy-icon-btn" type="button" aria-label="Copy link">
                    <!-- Simple copy icon using characters; you can replace with SVG if needed -->
                    ðŸ“‹ Copy Link
                </button>

                <p id="copyStatus" class="publish-label" style="display:none;"></p>
            </div>

            <p id="helpText" class="publish-label" style="display:none;">
                Share this link or convert it to a QR code for students/employees/citizens.
            </p>
        </div>

        <div class="publish-actions">
            <button class="secondary-btn" type="button" onclick="goBack()">Back</button>
        </div>
    </div>
</section>

<script>
const urlParams = new URLSearchParams(window.location.search);
const formId = urlParams.get("id");

const apiBase = "https://web-production-315e.up.railway.app";

const formInfo = document.getElementById("formInfo");
const errorBox = document.getElementById("errorBox");
const linkSection = document.getElementById("linkSection");
const generateBtn = document.getElementById("generateBtn");
const linkRow = document.getElementById("linkRow");
const linkBox = document.getElementById("linkBox");
const helpText = document.getElementById("helpText");
const copyBtn = document.getElementById("copyBtn");
const copyStatus = document.getElementById("copyStatus");

async function loadFormInfo() {
    if (!formId) {
        formInfo.textContent = "Form id is missing in URL.";
        return;
    }
    try {
        const res = await fetch(`${apiBase}/load-form-template?id=${formId}`);
        const data = await res.json();
        if (!res.ok) {
            formInfo.textContent = "Unable to load form information.";
            errorBox.textContent = data.error || "Unknown error.";
            errorBox.style.display = "block";
            return;
        }
        const name = data.name || "Untitled Form";
        const status = data.status || "draft";
        formInfo.textContent = `Form: ${name} (Status: ${status})`;

        linkSection.style.display = "block";
    } catch (e) {
        console.error(e);
        formInfo.textContent = "Unable to connect to server.";
    }
}

function generateLink() {
    const origin = window.location.origin;
    const path = window.location.pathname.split('/').slice(0, -1).join('/');
    const base = origin + path;
    const link = `${base}/public-form.html?id=${formId}`;

    linkBox.textContent = link;
    linkRow.style.display = "block";
    helpText.style.display = "block";
    copyStatus.style.display = "none";
    copyStatus.textContent = "";
}

async function copyLink() {
    const text = linkBox.textContent.trim();
    if (!text) return;

    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
        } else {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
        }
        copyStatus.textContent = "Link copied to clipboard.";
        copyStatus.style.display = "block";
    } catch (err) {
        console.error("Copy failed:", err);
        copyStatus.textContent = "Unable to copy. Please copy manually.";
        copyStatus.style.display = "block";
    }
}

function goBack() {
    window.location.href = "drafts.html";
}

generateBtn.addEventListener("click", generateLink);
copyBtn.addEventListener("click", copyLink);

loadFormInfo();
</script>

</body>
</html>
