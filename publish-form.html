<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Publish Form</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="publish-form.css">
    
</head>
<body>

<nav class="navbar">
    <div class="logo">Anonymous Feedback System - Admin</div>
</nav>

<section class="publish-container">
    <div class="publish-box">
        <h2>Publish Form</h2>
        <p class="subtext" id="formInfo">Loading form information...</p>

        <div id="errorBox" class="subtext" style="color:#ff6b6b; display:none;"></div>

        <div id="linkSection" style="display:none;">
            <p class="subtext">Click the button below to generate a public link for this form.</p>
            <button class="primary-btn" id="generateBtn" type="button">Generate Link</button>

            <div id="linkBox" class="publish-link-box" style="display:none;"></div>
            <p id="helpText" class="publish-label" style="display:none;">
                Share this link or convert it to a QR code for students/employees/citizens.
            </p>
        </div>

        <div class="publish-actions">
            <button class="secondary-btn" type="button" onclick="goBack()">Back</button>
        </div>
    </div>
</section>

<script>
const urlParams = new URLSearchParams(window.location.search);
const formId = urlParams.get("id");

const apiBase = "https://web-production-315e.up.railway.app";

const formInfo = document.getElementById("formInfo");
const errorBox = document.getElementById("errorBox");
const linkSection = document.getElementById("linkSection");
const generateBtn = document.getElementById("generateBtn");
const linkBox = document.getElementById("linkBox");
const helpText = document.getElementById("helpText");

async function loadFormInfo() {
    if (!formId) {
        formInfo.textContent = "Form id is missing in URL.";
        return;
    }
    try {
        const res = await fetch(`${apiBase}/load-form-template?id=${formId}`);
        const data = await res.json();
        if (!res.ok) {
            formInfo.textContent = "Unable to load form information.";
            errorBox.textContent = data.error || "Unknown error.";
            errorBox.style.display = "block";
            return;
        }
        const name = data.name || "Untitled Form";
        const status = data.status || "draft";
        formInfo.textContent = `Form: ${name} (Status: ${status})`;

        linkSection.style.display = "block";
    } catch (e) {
        console.error(e);
        formInfo.textContent = "Unable to connect to server.";
    }
}

function generateLink() {
    // Build base path including repo folder on GitHub Pages
    const origin = window.location.origin; // e.g. https://dhanushree-coder.github.io
    const path = window.location.pathname.split('/').slice(0, -1).join('/'); 
    // e.g. /anonymous-feedback-frontend

    const base = origin + path;
    const link = `${base}/public-form.html?id=${formId}`;

    linkBox.textContent = link;
    linkBox.style.display = "block";
    helpText.style.display = "block";
}

function goBack() {
    window.location.href = "drafts.html";
}

generateBtn.addEventListener("click", generateLink);

loadFormInfo();
</script>

</body>
</html>
