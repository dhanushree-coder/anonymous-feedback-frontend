<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form Analytics</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin-home.css">
    <!-- Only keeping local layout helpers; core theme + carousel in admin-home.css -->
    <style>
        .analytics-container {
            min-height: 100vh;
            padding-top: 70px;
            padding: 90px 40px 40px 40px;
        }

        .analytics-header {
            margin-bottom: 20px;
        }

        .analytics-header h2 {
            margin-bottom: 5px;
        }

        .bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .bar-label {
            min-width: 90px;
            font-size: 0.9rem;
            color: #e0fff3;
        }

        .bar-value {
            min-width: 30px;
            font-size: 0.85rem;
            text-align: right;
        }

        .estimate-row {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .estimate-row input[type="number"] {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #00ff99;
            background: transparent;
            color: #ffffff;
            outline: none;
            max-width: 120px;
        }

        .estimate-row button {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            background: #00ff99;
            color: #000000;
        }

        .estimate-row button:hover {
            box-shadow: 0 0 10px #00ff99;
        }

        .estimate-note {
            font-size: 0.8rem;
            color: #e0fff3;
        }

        .list-small {
            margin-top: 8px;
            max-height: 160px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .list-small li {
            margin-bottom: 4px;
        }

        .back-link-row {
            margin-top: 20px;
        }

        .back-link-row .secondary-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            background: #ff0066;
            color: #ffffff;
        }

        .back-link-row .secondary-btn:hover {
            box-shadow: 0 0 10px #ff0066;
        }

        @media (max-width: 768px) {
            .analytics-container {
                padding: 90px 20px 20px 20px;
            }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="logo">Anonymous Feedback System - Admin</div>
</nav>

<section class="analytics-container">
    <div class="analytics-header">
        <h2 id="formTitle">Form Analytics</h2>
        <p class="subtext" id="formMeta"></p>
    </div>

    <!-- Carousel arrows -->
    <button type="button" class="analytics-nav-arrow left" id="analyticsPrevBtn">&#8249;</button>
    <button type="button" class="analytics-nav-arrow right" id="analyticsNextBtn">&#8250;</button>

    <!-- Carousel wrapper -->
    <div class="analytics-grid" id="analyticsCarousel">
        <!-- Positive / Negative overview -->
        <div class="analytics-card">
            <h3>Positive vs Negative Feedback</h3>
            <p class="subtext">Overall distribution of feedback sentiment.</p>
            <div class="bar-chart" id="sentimentBars" data-bar-scope="sentiment"></div>
            <ul class="list-small" id="negativeReasonsList"></ul>
        </div>

        <!-- IP failures / spam -->
        <div class="analytics-card">
            <h3>Failed / Blocked Attempts</h3>
            <p class="subtext">Estimated number of IPs blocked by rate limits.</p>
            <div id="failedAttemptsStats" class="subtext"></div>
        </div>

        <!-- Estimated vs actual -->
        <div class="analytics-card">
            <h3>Estimated vs Actual Submissions</h3>
            <p class="subtext">Compare your target with actual responses.</p>
            <div class="estimate-row">
                <label for="estimateInput">Estimated:</label>
                <input type="number" id="estimateInput" min="0" placeholder="e.g. 100">
                <button id="saveEstimateBtn" type="button">Save Estimate</button>
            </div>
            <p id="estimateInfo" class="estimate-note"></p>
            <div class="bar-chart" id="estimateBars" data-bar-scope="estimate" style="margin-top:10px;"></div>
        </div>

        <!-- Key patterns & improvement areas -->
        <div class="analytics-card">
            <h3>Key Patterns & Improvement Areas</h3>
            <p class="subtext">Words and sections that need attention.</p>
            <ul class="list-small" id="keywordsList"></ul>
            <div class="bar-chart" id="sectionBars" data-bar-scope="sections" style="margin-top:10px;"></div>
        </div>
    </div>

    <div class="back-link-row">
        <button class="secondary-btn" type="button" onclick="goBackToDashboard()">← Back to Dashboard</button>
    </div>
</section>

<script>
const API_BASE = "https://web-production-315e.up.railway.app";
const urlParams = new URLSearchParams(window.location.search);
const formId = urlParams.get("form_id");

const formTitleEl = document.getElementById("formTitle");
const formMetaEl = document.getElementById("formMeta");
const sentimentBars = document.getElementById("sentimentBars");
const negativeReasonsList = document.getElementById("negativeReasonsList");
const failedAttemptsStats = document.getElementById("failedAttemptsStats");
const estimateInput = document.getElementById("estimateInput");
const estimateInfo = document.getElementById("estimateInfo");
const estimateBars = document.getElementById("estimateBars");
const keywordsList = document.getElementById("keywordsList");
const sectionBars = document.getElementById("sectionBars");
const saveEstimateBtn = document.getElementById("saveEstimateBtn");

function goBackToDashboard() {
    window.location.href = "admin-dashboard.html";
}

/* Helper to create an animated bar row.
   We reset width and opacity first, then animate like your skill bars. */
function createBarRow(label, value, maxValue, isNegative = false) {
    const row = document.createElement("div");
    row.className = "bar-row";

    const lbl = document.createElement("div");
    lbl.className = "bar-label";
    lbl.textContent = label;

    const track = document.createElement("div");
    track.className = "bar-track";

    const fill = document.createElement("div");
    fill.className = "bar-fill";
    if (isNegative) fill.classList.add("negative");

    const val = document.createElement("div");
    val.className = "bar-value";
    val.textContent = value;

    track.appendChild(fill);
    row.appendChild(lbl);
    row.appendChild(track);
    row.appendChild(val);

    const pct = maxValue > 0 ? (value / maxValue) * 100 : 0;

    // Start from 0 like portfolio skill progress
    fill.style.width = "0%";
    fill.style.opacity = "0";

    requestAnimationFrame(() => {
        // next frame – trigger smooth transition
        fill.style.opacity = "1";
        fill.style.width = pct + "%";
    });

    return row;
}

/* Re‑animate all bars inside a given container (used when slide becomes active) */
function reanimateBarsIn(container) {
    const fills = container.querySelectorAll(".bar-fill");
    fills.forEach(fill => {
        const targetWidth = fill.getAttribute("data-target-width");
        if (!targetWidth) return;
        fill.style.transition = "none";
        fill.style.width = "0%";
        fill.style.opacity = "0";
        // force reflow
        void fill.offsetWidth;
        fill.style.transition = "width 1s ease-in-out, opacity 0.5s ease-in-out";
        requestAnimationFrame(() => {
            fill.style.opacity = "1";
            fill.style.width = targetWidth;
        });
    });
}

/* Load main analytics summary */
async function loadSummary() {
    if (!formId) {
        formTitleEl.textContent = "Invalid form id";
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/admin/form-analytics/summary?form_id=${formId}`);
        const data = await res.json();
        if (!res.ok) {
            formTitleEl.textContent = "Unable to load analytics";
            formMetaEl.textContent = data.error || "Unknown error";
            return;
        }

        formTitleEl.textContent = data.form_name || `Form ${formId}`;
        formMetaEl.textContent = `Total submissions: ${data.total || 0} | Average rating: ${data.avg_rating || 0}`;

        /* Sentiment bars */
        sentimentBars.innerHTML = "";
        const maxSent = Math.max(data.positives || 0, data.negatives || 0, 1);
        const posRow = createBarRow("Positive", data.positives || 0, maxSent, false);
        const negRow = createBarRow("Negative", data.negatives || 0, maxSent, true);

        // store final width for re‑animation
        posRow.querySelector(".bar-fill").setAttribute(
            "data-target-width",
            `${(data.positives || 0) / maxSent * 100}%`
        );
        negRow.querySelector(".bar-fill").setAttribute(
            "data-target-width",
            `${(data.negatives || 0) / maxSent * 100}%`
        );

        sentimentBars.appendChild(posRow);
        sentimentBars.appendChild(negRow);

        /* Negative reasons list */
        negativeReasonsList.innerHTML = "";
        (data.negative_reasons || []).forEach(item => {
            const li = document.createElement("li");
            li.textContent = `• ${item.reason_text} (${item.count} times)`;
            negativeReasonsList.appendChild(li);
        });

        /* Failed attempts */
        failedAttemptsStats.textContent = `Approximate blocked attempts: ${data.blocked_attempts || 0}`;

        /* Estimate info & bars */
        if (data.estimated_submissions != null) {
            estimateInput.value = data.estimated_submissions;
            estimateInfo.textContent = `Estimated: ${data.estimated_submissions}, Actual: ${data.total || 0}`;
        } else {
            estimateInfo.textContent = `No estimate saved yet. Enter a value and click Save Estimate.`;
        }

        estimateBars.innerHTML = "";
        const est = data.estimated_submissions || 0;
        const act = data.total || 0;
        const maxEA = Math.max(est, act, 1);
        const estRow = createBarRow("Estimated", est, maxEA, false);
        const actRow = createBarRow("Actual", act, maxEA, true);

        estRow.querySelector(".bar-fill").setAttribute(
            "data-target-width",
            `${(est || 0) / maxEA * 100}%`
        );
        actRow.querySelector(".bar-fill").setAttribute(
            "data-target-width",
            `${(act || 0) / maxEA * 100}%`
        );

        estimateBars.appendChild(estRow);
        estimateBars.appendChild(actRow);

    } catch (e) {
        console.error("loadSummary error:", e);
    }
}

/* Load keywords and section improvement areas */
async function loadPatterns() {
    try {
        const res = await fetch(`${API_BASE}/admin/form-analytics/patterns?form_id=${formId}`);
        const data = await res.json();
        if (!res.ok) {
            return;
        }

        /* Keywords */
        keywordsList.innerHTML = "";
        (data.keywords || []).forEach(k => {
            const li = document.createElement("li");
            li.textContent = `• "${k.word}" (${k.count} times)`;
            keywordsList.appendChild(li);
        });

        /* Section improvement bars */
        sectionBars.innerHTML = "";
        const maxScore = Math.max(...(data.sections || []).map(s => s.issue_score || 0), 1);
        (data.sections || []).forEach(s => {
            const row = createBarRow(s.section_name || "Section", s.issue_score || 0, maxScore, true);
            row.querySelector(".bar-fill").setAttribute(
                "data-target-width",
                `${(s.issue_score || 0) / maxScore * 100}%`
            );
            sectionBars.appendChild(row);
        });
    } catch (e) {
        console.error("loadPatterns error:", e);
    }
}

/* Save estimate */
saveEstimateBtn.addEventListener("click", async () => {
    const val = parseInt(estimateInput.value || "0", 10);
    if (val < 0) {
        alert("Estimate cannot be negative.");
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/admin/form-analytics/estimated`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ form_id: parseInt(formId, 10), estimated_submissions: val })
        });
        const data = await res.json();
        if (!res.ok) {
            alert(data.error || "Failed to save estimate");
            return;
        }
        await loadSummary();
    } catch (e) {
        console.error("saveEstimate error:", e);
    }
});

/* ===== Carousel logic for analytics cards (one card at a time) ===== */
const carouselEl = document.getElementById("analyticsCarousel");
const prevBtn = document.getElementById("analyticsPrevBtn");
const nextBtn = document.getElementById("analyticsNextBtn");
const slides = carouselEl.querySelectorAll(".analytics-card");

let currentIndex = 0;
let autoSlideTimer = null;

function showSlide(index) {
    if (slides.length === 0) return;

    if (index < 0) index = slides.length - 1;
    if (index >= slides.length) index = 0;

    currentIndex = index;

    const offset = carouselEl.clientWidth * currentIndex;
    carouselEl.scrollTo({
        left: offset,
        behavior: "smooth"
    });

    // Re‑animate bars only for the visible slide to mimic your skill hover smoothness
    const activeSlide = slides[currentIndex];
    const barContainers = activeSlide.querySelectorAll(".bar-chart");
    barContainers.forEach(container => reanimateBarsIn(container));
}

function nextSlide() {
    showSlide(currentIndex + 1);
}

function prevSlide() {
    showSlide(currentIndex - 1);
}

/* Manual navigation */
prevBtn.addEventListener("click", () => {
    prevSlide();
    resetAutoSlide();
});

nextBtn.addEventListener("click", () => {
    nextSlide();
    resetAutoSlide();
});

/* Auto slide every 5 seconds */
function startAutoSlide() {
    stopAutoSlide();
    autoSlideTimer = setInterval(() => {
        nextSlide();
    }, 5000);
}

function stopAutoSlide() {
    if (autoSlideTimer) {
        clearInterval(autoSlideTimer);
        autoSlideTimer = null;
    }
}

function resetAutoSlide() {
    startAutoSlide();
}

/* Initial load: data then carousel start so layout is stable */
document.addEventListener("DOMContentLoaded", async () => {
    await loadSummary();
    await loadPatterns();
    showSlide(0);
    startAutoSlide();
});
</script>

</body>
</html>
